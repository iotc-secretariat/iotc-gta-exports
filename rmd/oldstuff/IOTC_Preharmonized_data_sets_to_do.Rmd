---
title: "The FIRMS Global Tuna Atlas: Exporting the nominal catch data set"
author: "IOTC Secretariat"
classoption: landscape
header-includes:
- \usepackage[justification=raggedright,labelfont=bf,singlelinecheck=false]{caption}   #left align caption of kables
- \newcommand{\beginsupplement}{\setcounter{table}{0}  \renewcommand{\thetable}{S\arabic{table}} \setcounter{figure}{0} \renewcommand{\thefigure}{S\arabic{figure}}}
urlcolor: blue
---
  
```{r general_options,echo=FALSE}
knitr::opts_chunk$set(echo = FALSE,tidy.opts=list(width.cutoff=100),tidy=TRUE,size="small")
knit_hooks$set(inline = function(x) {prettyNum(x, big.mark=",")})
```

\pagebreak

# SUMMARY

The document describes the processing steps to export the latest version of the IOTC nominal catches to the FIRMS Global Tuna Atlas. Nominal catches correspond to the total annual retained catches (i.e. excluding discards) in live weight (t) by large IOTC area, species, fishing gear, and fleet for tuna and tuna-like species occurring in the Indian Ocean during the period 1950-2019 ([https://iotc.org/data/datasets](https://iotc.org/data/datasets)). The data differ from the best scientific estimates used for stock assessment purposes as they include some catches of IOTC species aggregated by species (e.g. tunas nei) or gear (e.g. gillnet operated attached to a longline). Two data sets are produced: (1) the pre-harmonized data set based on IOTC code lists and (2) the final IOTC component of the global nominal catch data set after mapping with the standard code lists adopted for the Global Tuna Atlas.

# CODES

## Data inputs

```{r Rlibraries, echo = TRUE, results="hide"}
# Load R libraries
pacman::p_load("knitr", "lubridate", "iotc.base.common.data")
```

```{r ExtractNominalCatches,echo=TRUE}
# Extract raw official NC data for tuna and tuna-like species
NCRAW = NC_raw_off(species_category_codes = c("BILLFISH","NERITIC","TEMPERATE","TROPICAL","TUNAS_NEI","SEERFISH"), factorize_result = FALSE)
```

## Filtering

```{r FilterNominalCatches, echo = TRUE}
# Species not occurring in the Indian Ocean
SpeciesToExclude = c("SBF", "SAI", "SPF", "BFT", "WHM", "LTA", "MLW")
SpeciesExcluded = unique(NCRAW[SPECIES_CODE %in% SpeciesToExclude, SPECIES_CODE])

# Exclude the species from the NC data set
NC = NCRAW[!SPECIES_CODE %in% SpeciesExcluded]
```

## Formatting

### Nominal catches

```{r FormatNominalCatches, echo = TRUE}
# Add school type, catch type, unit and source authority (use "t" instead of "MT" in the export?)
NC[, `:=` (schooltype = "ALL", catchtype = "ALL", unit = "MT", source_authority = "IOTC")]

# Format IOTC areas
NC[, geographic_identifier := fifelse(FISHING_GROUND_CODE == "IREASIO", "F57", fifelse(FISHING_GROUND_CODE == "IRWESIO", "F51", "OTHER"))]

# Add time_start and time_end
NC[, `:=` (time_start = as.Date(paste(YEAR, "-01-01" , sep = ""), format = "%Y-%m-%d"), time_end = as.Date(paste(YEAR, "-12-31" , sep = ""), format = "%Y-%m-%d"))]
```

## Exporting

### Pre-harmonized data set

```{r ExportNominalCatchDataSetPH, echo = TRUE}
# Build the nominal catch data set with IOTC code lists
NCIOTC = NC[, .(value = sum(CATCH)), keyby = .(fleet = FLEET_CODE, gear = GEAR_CODE, time_start, time_end, geographic_identifier, schooltype, species = SPECIES_CODE, catchtype, unit, source_authority)]

# Reorder the pre-harmonized data set
setcolorder(NCIOTC,neworder = c("fleet", "gear", "time_start", "time_end", "geographic_identifier", "schooltype", "species", "catchtype", "unit", "value", "source_authority"))

# Export the pre-harmonized data set
write.csv(NCIOTC, file = paste0("../outputs/datasets/nominal_catch_iotc_level0_", Sys.Date(), ".csv"), row.names = FALSE)
```
