---
title: "The FIRMS Global Tuna Atlas: Exporting the geo-referenced surface fisheries catch data sets"
author: "IOTC Secretariat"
classoption: landscape
header-includes:
- \usepackage[justification=raggedright,labelfont=bf,singlelinecheck=false]{caption}   #left align caption of kables
- \newcommand{\beginsupplement}{\setcounter{table}{0}  \renewcommand{\thetable}{S\arabic{table}} \setcounter{figure}{0} \renewcommand{\thefigure}{S\arabic{figure}}}
urlcolor: blue
---
  
```{r general_options, echo = FALSE}
options(scipen = 999)
knitr::opts_chunk$set(echo = FALSE,tidy.opts=list(width.cutoff=100),tidy=TRUE,size="small")
knit_hooks$set(inline = function(x) {prettyNum(x, big.mark=",")})
options(knitr.kable.NA = '')
```

\pagebreak

# SUMMARY

The document describes the processing steps to export the latest version of the geo-referenced catches of surface fisheries to the FIRMS Global Tuna Atlas. Geo-referenced catch data correspond to the catch by species in live weight and fishing effort by type of fishery by grid area and month strata and should be extrapolated to annual catch in the case of surface fisheries ([https://iotc.org/data/datasets](https://iotc.org/data/datasets)). The data set produced is the IOTC component of the global catch data set of surface fisheries (i.e. baitboat and purse seine fisheries) by 1° grid area and month strata after mapping with the standard code lists adopted for the Global Tuna Atlas.

# CODES

## Data inputs

```{r Rlibraries, echo = TRUE, results = "hide"}
# Load R libraries
pacman::p_load("knitr", "lubridate", "iotc.base.common.data")
```

```{r ReadCodeLists, echo = TRUE}
# Read standard code lists adopted for the GTA
Species = fread("../inputs/codelists/species_asfis.csv", encoding = "UTF-8")
Gears = fread("../inputs/codelists/isscfg_revision_1.csv", colClasses = "character", encoding = "UTF-8")
Fleets = fread("../inputs/codelists/flag_fao_cwp.csv", encoding = "UTF-8") #outdated
```

```{r ReadMappingFiles, echo = TRUE}
# Read mapping files (updated 15 March 2021)
MappingSpecies = fread("../inputs/mappings/codelist_mapping_species_iotc_species_asfis.csv")
MappingGear = fread("../inputs/mappings/codelist_mapping_gear_iotc_isscfg_revision_1.csv", colClasses = "character")
MappingFleet = fread("../inputs/mappings/codelist_mapping_fleet_iotc_fleet_firms.csv")
```

```{r ExtractGeoreferencedSurfaceFisheriesCatches, cache = TRUE, echo = TRUE}
# Extract geo-referenced baitboat and purse seine catch data (t) for tuna and tuna-like species
CASURFRAW = CA_raw_off(fishery_group_codes = c("BB", "PS"), species_category_codes = c("BILLFISH", "NERITIC", "TEMPERATE", "TROPICAL", "TUNAS_NEI", "SEERFISH"), factorize_result = FALSE, catch_unit_codes = "MT")
```

## Filtering

```{r FilterGeoreferencedSurfaceFisheriesCatches, echo = TRUE}
# Species not occurring in the Indian Ocean
SpeciesToExclude = c("SBF", "SAI", "SPF", "BFT", "WHM", "LTA", "MLW")
SpeciesExcluded = unique(CASURFRAW[SPECIES_CODE %in% SpeciesToExclude, SPECIES_CODE])

# Species not occurring in the Indian Ocean
CASURF = CASURFRAW[!SPECIES_CODE %in% SpeciesExcluded]
```

```{r FilterGeoreferencedSurfaceFisheriesCatches11M, echo = TRUE}
# Restrict to data reported with a 1x1 grid spatial resolution AND a monthly temporal resolution
CASURF11M = CASURF[as.numeric(substr(FISHING_GROUND_CODE,1,1)) == 5 & MONTH_END-MONTH_START == 0]
```

## Formatting

### Pre-harmonized original data set

```{r FormatGeoreferencedSurfaceFisheriesCatchDataSetPH,echo=TRUE}
# Add source authority, catch type and unit
CASURF[, `:=` (source_authority = "IOTC", unit = "MT", catchtype = "ALL")]

# Add time_start and time_end
CASURF[, `:=` ( time_start = as.Date(paste(YEAR, "-", MONTH_START, "-01", sep = ""), format = "%Y-%m-%d"), time_end = as.Date(paste(YEAR, "-", MONTH_END, "-01", sep = ""), format = "%Y-%m-%d") %m+% months(1) - 1 ) ]
```

### Final monthly 1x1 data set

```{r FormatGeoreferencedSurfaceFisheriesCatchDataSetFH, echo = TRUE}
# Add source authority and unit
CASURF11M[, `:=` (source_authority = "IOTC", unit = "t", catchtype = "UNK")]

# Add time_start and time_end
CASURF11M[, `:=` ( time_start = as.Date(paste(YEAR, "-", MONTH_START, "-01", sep = ""), format = "%Y-%m-%d"), time_end = as.Date(paste(YEAR, "-", MONTH_END, "-01", sep = ""), format = "%Y-%m-%d") %m+% months(1) - 1 ) ]
```

## Mapping

```{r MapGeoreferencedSurfaceFisheriesCatchDataSetFH, echo = TRUE}
# Merge with ASFIS species list
CASURF11M_MAPPEDSPECIES = merge(CASURF11M, MappingSpecies[src_codingsystem == "species_iotc" & trg_codingsystem == "species_asfis", .(src_code, species = trg_code)], by.x = "SPECIES_CODE", by.y = "src_code", all.x = TRUE)

# Merge with ISSCFG gear list
CASURF11M_MAPPEDSPECIESGEAR = merge(CASURF11M_MAPPEDSPECIES, MappingGear[src_codingsystem == "gear_iotc" & trg_codingsystem == "isscfg_revision_1", .(src_code, gear = trg_code)], by.x = "GEAR_CODE", by.y = "src_code", all.x = TRUE)

# Merge with FIRMS fleet list
CASURF11M_MAPPEDSPECIESGEARFLEET = merge(CASURF11M_MAPPEDSPECIESGEAR, MappingFleet[src_codingsystem == "fleet_iotc" & trg_codingsystem == "fleet_firms", .(src_code, fleet = trg_code)], by.x = "FLEET_CODE", by.y = "src_code", all.x=TRUE)
```

```{r CheckCompleteMapping, echo = FALSE}
# Check if missing species
if (nrow(CASURF11M_MAPPEDSPECIES[is.na(species)])>0) print( paste("The following species codes are missing from the mapping: ", paste0(unique(CASURF11M_MAPPEDSPECIES[is.na(species), SPECIES_CODE]), collapse = "|")))

# Check if missing gears
if (nrow(CASURF11M_MAPPEDSPECIESGEAR[is.na(gear)])>0) print( paste("The following gear codes are missing from the mapping: ", paste0(unique(CASURF11M_MAPPEDSPECIESGEAR[is.na(gear), GEAR_CODE]), collapse = "|")))

# Check if missing fleets
if (nrow(CASURF11M_MAPPEDSPECIESGEARFLEET[is.na(fleet)])>0) print( paste("The following flag codes are missing from the mapping: ", paste0(unique(CASURF11M[is.na(fleet), FLAG_CODE]), collapse = "|")))
```

## Exporting

### Pre-harmonized data set

```{r ExportGeoreferencedSurfaceFisheriesCatchDataSetPH, echo = TRUE}
# Build the full surface fisheries data set with IOTC code lists
CASURFIOTC = CASURF[,.(value = sum(CATCH, na.rm = TRUE)), by= .(fleet = FLEET_CODE, gear = GEAR_CODE, time_start, time_end, geographic_identifier = FISHING_GROUND_CODE, schooltype = CATCH_SCHOOL_TYPE_CODE, species = SPECIES_CODE, catchtype, unit, source_authority)]

# Order columns
setcolorder(CASURFIOTC, neworder = c("fleet", "gear", "time_start", "time_end", "geographic_identifier", "schooltype", "species", "catchtype", "unit", "value", "source_authority"))

# Export the full surface fisheries data set with IOTC code lists
write.csv(CASURFIOTC, file = paste0("../outputs/datasets/catch_iotc_level0__surface_", Sys.Date(), ".csv"), row.names = FALSE)
```

### Final monthly 1x1 data set

```{r ExportGeoreferencedSurfaceFisheriesCatchDataSetFH, echo = TRUE}
# Build the 1x1 monthly surface fisheries data set with mapping to GTA code lists
CASURF11MFIRMS = CASURF11M_MAPPEDSPECIESGEARFLEET[, .(value = sum(CATCH, na.rm = TRUE)), by= .(fleet = FLEET_CODE, gear = GEAR_CODE, time_start, time_end, geographic_identifier = FISHING_GROUND_CODE, schooltype = CATCH_SCHOOL_TYPE_CODE, species = species, catchtype, unit, source_authority)]

# Order columns
setcolorder(CASURF11MFIRMS,neworder = c("fleet", "gear", "time_start", "time_end", "geographic_identifier", "schooltype", "species", "catchtype", "unit", "source_authority", "value"))

# Export the 1x1 monthly surface fisheries data set with mapping to GTA code lists
write.csv(CASURF11MFIRMS, file = paste0("../outputs/datasets/iotc_catch_1deg_1m_ps_bb_firms_level0_", Sys.Date(), ".csv"),row.names = FALSE)
```

\pagebreak

# RESULTS

The data processing resulted in the removal of `r round( sum(CASURFRAW$CATCH) - sum(CASURF11M_MAPPEDSPECIESGEARFLEET$CATCH) )` t of fish from the original data set through the filtering of species and spatio-temporal strata (**Table 1**). The mapping to the standard code lists reduced the number of gears from `r length(unique(CASURF11M_MAPPEDSPECIES$GEAR_CODE))` to `r length(unique(CASURF11M_MAPPEDSPECIESGEAR$gear))` and the fleets from `r length(unique(CASURF11M_MAPPEDSPECIES$FLEET_CODE))` to `r length(unique(CASURF11M_MAPPEDSPECIESGEARFLEET$fleet))` (**Table 1**). The species-specific nominal catches included in the IOTC component of the FIRMS Global Tuna Atlas are included in **Table 4**.

**Table 1:** Description of the main components of the geo-referenced surface fisheries catch data sets throughout the processing steps for building the IOTC component of the FIRMS Global Tuna Atlas

| Data set  | Description | Species | Gears | Fleets | Catches |
| :---------------------------------  | :------------------------------------- | ----: | ----: | ----: | --------: |
| CASURFRAW  | All tuna and tuna-like species, gears, and fleets | `r length(unique(CASURFRAW$SPECIES_CODE))` | `r length(unique(CASURFRAW$GEAR_CODE))` | `r length(unique(CASURFRAW$FLEET_CODE))` | `r round(sum(CASURFRAW$CATCH))` |
| CASURF     | Removal of species not occurring in the Indian Ocean | `r length(unique(CASURF$SPECIES_CODE))` | `r length(unique(CASURF$GEAR_CODE))` | `r length(unique(CASURF$FLEET_CODE))` | `r round(sum(CASURF$CATCH))` |
| CASURF11M  | Selection of monthly 1x1 strata  | `r length(unique(CASURF11M$SPECIES_CODE))` | `r length(unique(CASURF11M$GEAR_CODE))` | `r length(unique(CASURF11M$FLEET_CODE))` | `r round(sum(CASURF11M$CATCH))` |
| CASURF11M_MAPPEDSPECIES | Species mapped with ASFIS code list | `r length(unique(CASURF11M_MAPPEDSPECIES$species))` | `r length(unique(CASURF11M_MAPPEDSPECIES$GEAR_CODE))` | `r length(unique(CASURF11M_MAPPEDSPECIES$FLEET_CODE))` | `r round(sum(CASURF11M_MAPPEDSPECIES$CATCH))` |
| CASURF11M_MAPPEDSPECIESGEAR | Gears mapped with ISSCFG code list | `r length(unique(CASURF11M_MAPPEDSPECIESGEAR$species))` | `r length(unique(CASURF11M_MAPPEDSPECIESGEAR$gear))` | `r length(unique(CASURF11M_MAPPEDSPECIESGEAR$FLEET_CODE))` | `r round(sum(CASURF11M_MAPPEDSPECIESGEAR$CATCH))` |
| CASURF11M_MAPPEDSPECIESGEARFLEET | Fleets mapped with FIRMS fleet code list | `r length(unique(CASURF11M_MAPPEDSPECIESGEARFLEET$species))` | `r length(unique(CASURF11M_MAPPEDSPECIESGEARFLEET$gear))` | `r length(unique(CASURF11M_MAPPEDSPECIESGEARFLEET$fleet))` | `r round(sum(CASURF11M_MAPPEDSPECIESGEARFLEET$CATCH))` |

<br />

```{r GeoreferencedSurfaceFisheriesCatchBySpeciesExcluded}
CASURFSPECIESEXCLUDED = CASURFRAW[SPECIES_CODE %in% SpeciesExcluded, .(YEAR_START = min(YEAR), YEAR_END = max(YEAR), CATCH = sum(CATCH)), keyby = .(SPECIES_CODE)]

# Add species information
CASURFSPECIESEXCLUDEDTABLE = merge(CASURFSPECIESEXCLUDED, Species[,.(code,label,scientific_name,family)], by.x = "SPECIES_CODE", by.y = "code", all.x = TRUE)[, .(CODE = SPECIES_CODE, FAMILY = family, NAME = label, SCIENTIFIC_NAME = paste0("_", scientific_name, "_"), YEAR_START, YEAR_END, CATCH = prettyNum(round(CATCH), big.mark = ","))][order(FAMILY, CODE)]
```

A total of `r length(unique(SpeciesExcluded))` species were removed from the data set, representing `r sum(CASURFRAW[SPECIES_CODE %in% SpeciesExcluded,CATCH])` t of fish, i.e. `r round(sum(CASURFRAW[SPECIES_CODE %in% SpeciesExcluded,CATCH])/sum(CASURFRAW$CATCH)*100,1)`% of the total nominal catches reported to the Secretariat during 1950-2019. The catches excluded are dominated by southern bluefin tuna (SBF) which represented `r round(sum(CASURFRAW[SPECIES_CODE == "SBF",CATCH])/sum(CASURFRAW[SPECIES_CODE %in% SpeciesExcluded,CATCH])*100,2)`% of the total catches excluded from the original data set (**Table 2**). SBF catches are available from the CCSBT data sets available in the FIRMS Global Tuna Atlas. The other species removed only occurs in the Atlantic Ocean.

```{r DisplayGeoreferencedSurfaceFisheriesCatchBySpeciesExcluded}
kable(CASURFSPECIESEXCLUDEDTABLE, row.names = FALSE, align = c("l", "l", "l" ,"l", "r", "r", "r"), caption = "Total geo-referenced catches (t) of tuna and tuna-like species included in the IOTC database for the period 1950-2019 and excluded from the data set exported to the FIRMS Tuna Atlas following the filter on species")
```

```{r SpatialStrataExcludedDataFromGeoreferencedSurfaceFisheriesCatches11M, echo = FALSE}
# Extract data not complying with 1x1 grids
CASURFEXCLUDEDSPATIAL = merge(CASURF[as.numeric(substr(FISHING_GROUND_CODE,1,1)) != 5],  filter_grids()[, .(FISHING_GROUND_CODE, FISHING_GROUND_TYPE)], by = "FISHING_GROUND_CODE", all.x = TRUE)

# Irregular grids (not included in filter_grids())
CASURFEXCLUDEDSPATIAL[is.na(FISHING_GROUND_TYPE), FISHING_GROUND_TYPE := "IRREGULAR"]

# Compute the catches excluded by type of grid
CASURFEXCLUDEDSPATIALTABLE = CASURFEXCLUDEDSPATIAL[, .(CATCH = prettyNum(round(sum(CATCH)),big.mark = ",")), keyby = .(FISHING_GROUND_TYPE)]
```

```{r TemporalStrataExcludedDataFromGeoreferencedSurfaceFisheriesCatches11M}
# Extract data not complying with monthly temporal resolution
CASURFSEXCLUDEDTEMPORAL = CASURF[MONTH_END-MONTH_START != 0]

# Compute the monthly difference
CASURFSEXCLUDEDTEMPORAL[, MONTH_DIFF := MONTH_END-MONTH_START]

# Compute the 
CASURFSEXCLUDEDTEMPORALTABLE = CASURFSEXCLUDEDTEMPORAL[, .(CATCH = prettyNum(round(sum(CATCH)), big.mark = ",")), keyby= .(MONTH_DIFF)]
```

A total of `r length(unique(CASURFEXCLUDEDSPATIAL$FISHING_GROUND_CODE))` spatial grids different from the 1x1° resolution were removed from the data set, representing `r round(sum(CASURFEXCLUDEDSPATIAL$CATCH))` t of fish. The catches excluded from the data set by type of spatial stratum are given in **Table 3**. Furthermore, some catch data were reported with a temporal resolution larger than 1 month, corresponding to a total of `r round(sum(CASURFSEXCLUDEDTEMPORAL$CATCH))` t of fish in the original data set.

```{r DisplayGeoreferencedSurfaceFisheriesCatchSpatialExcluded}
kable(CASURFEXCLUDEDSPATIALTABLE, row.names = FALSE, align = c("l", "l", "l", "l", "r", "r", "r"), caption = "Total geo-referenced catches (t) of tuna and tuna-like species by surface fisheries as included in the IOTC database for the period 1950-2019 and excluded from the data set exported to the FIRMS Tuna Atlas following the filter on spatial strata resolution")
```

```{r GeoreferencedSurfaceFisheriesCatchBySpeciesIncluded}
# Compute catch by species
CASURF11MFIRMS_SPECIESINCLUDED = CASURF11MFIRMS[, .(START = min(year(time_start)), END = max(year(time_end)), CATCH = sum(value)), keyby=.(species)]

# Add species information
CASURF11MFIRMS_SPECIESINCLUDEDTABLE = merge(CASURF11MFIRMS_SPECIESINCLUDED[round(CATCH)>0], Species[, .(code, label, scientific_name, family)], by.x = "species", by.y = "code", all.x = TRUE)[, .(CODE = species, FAMILY = family, NAME = label, SCIENTIFIC_NAME = fifelse(scientific_name != "NA", paste0("_", scientific_name, "_"), ""), START, END, CATCH = prettyNum(round(CATCH), big.mark = ","))][order(FAMILY, CODE)]
```

```{r DisplayNominalCatchBySpecies}
kable(CASURF11MFIRMS_SPECIESINCLUDEDTABLE, row.names = FALSE, align = c("l", "l", "l", "l", "r", "r", "r"), caption = "Total geo-referenced catches (t) of tuna and tuna-like species by surface fisheries as included in the data set exported to the FIRMS Global Tuna Atlas")
```

\pagebreak

# MAPPING TABLES

\beginsupplement

```{r MappingSpeciesTable}
kable(MappingSpecies[src_code != trg_code, .(IOTC = src_code, ASFIS = trg_code)], row.names = TRUE, caption = "Mapping of species or groups of species codes from the IOTC database to the ASFIS code list used for the FIRMS Global Tuna Atlas when the source and target codes differ")
```

\pagebreak

```{r MappingGearsTable}
kable(MappingGear[, .(IOTC = src_code, ISSCFG = trg_code)], row.names = TRUE, caption = "Mapping of gears or groups of gear codes from the IOTC database to the ISSCFG code list used for the FIRMS Global Tuna Atlas")
```

\pagebreak

```{r MappingFleetsTable}
kable(MappingFleet[src_code != trg_code, .(IOTC = src_code, FIRMS = trg_code)], row.names = TRUE, caption = "Mapping of fleet codes from the IOTC database to the code list used for the FIRMS Global Tuna Atlas when the source and target codes differ")
```

