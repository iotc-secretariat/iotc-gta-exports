---
title: "The FIRMS Global Tuna Atlas: The full geo-referenced catch data set"
author: "IOTC Secretariat"
classoption: landscape
header-includes:
- \usepackage[justification=raggedright,labelfont=bf,singlelinecheck=false]{caption}   #left align caption of kables
- \newcommand{\beginsupplement}{\setcounter{table}{0}  \renewcommand{\thetable}{S\arabic{table}} \setcounter{figure}{0} \renewcommand{\thefigure}{S\arabic{figure}}}
urlcolor: blue
---
  
```{r general_options, echo = FALSE}
options(scipen = 999)
knitr::opts_chunk$set(echo = FALSE,tidy.opts=list(width.cutoff=100),tidy=TRUE,size="small")
knit_hooks$set(inline = function(x) {prettyNum(x, big.mark=",")})
options(knitr.kable.NA = '')
```

# SUMMARY {-}

Geo-referenced catch data correspond to the catch by species in live weight and fishing effort by type of fishery by grid area and month strata ([https://iotc.org/data/datasets](https://iotc.org/data/datasets)). The document describes the processing steps to produce the latest version of the geo-referenced catches of all fisheries by grid area and month strata after mapping with the standard code lists adopted for the FIRMS Global Tuna Atlas.

\tableofcontents

\pagebreak

# CODES

```{r child = "IOTC_Data_Inputs.Rmd"}
```

```{r Data_extraction, cache = TRUE, echo = TRUE}
# Extract geo-referenced catch data (t) for tuna and tuna-like species
CA_RAW = CA_raw_off(species_category_codes = c("BILLFISH", "NERITIC", "TEMPERATE", "TROPICAL", "TUNAS_NEI", "SEERFISH"), factorize_result = FALSE)
```

## Filtering

```{r child = "IOTC_Species_To_Exclude.Rmd"}
```

```{r FilterGeoreferencedFisheriesCatches, echo = TRUE}
# Exclude the species from the data set
SpeciesExcluded = unique(CA_RAW[SPECIES_CODE %in% SpeciesToExclude, SPECIES_CODE])
CA_IO = CA_RAW[!SPECIES_CODE %in% SpeciesExcluded]
```

```{r Spatiotemporal_Strata_Filtering, echo = TRUE}
# Restrict to regular grid spatial resolution
CA = CA_IO[as.numeric(substr(FISHING_GROUND_CODE,1,1)) %in% c(1,2,3,4,5,6)]
```

## Formatting

```{r Fields_Addition_Formatting, echo = TRUE}
# Add source authority
CA[, `:=` (source_authority = "IOTC")]

# Add catch type
CA[, `:=` (catchtype = "UNK")]
 
# Add unit
CA[, `:=` (unit = fifelse(CATCH_UNIT_CODE == "MT", "t", fifelse(CATCH_UNIT_CODE == "NO", "no", "unk")))]

# Add school type
CA[, `:=` (schooltype = fifelse(CATCH_SCHOOL_TYPE_CODE == "LA", "LS",
                                    fifelse(CATCH_SCHOOL_TYPE_CODE == "UNCL", "UNK", 
                                            fifelse(CATCH_SCHOOL_TYPE_CODE == "FD", "DEL",
                                                    CATCH_SCHOOL_TYPE_CODE))))]

# Add time_start
CA[, `:=` (time_start = as.Date(paste(YEAR, "-", MONTH_START, "-01", sep = ""), format = "%Y-%m-%d")) ]

# Add time_end
CA[, `:=` (time_end = as.Date(paste(YEAR, "-", MONTH_END, "-01", sep = ""), format = "%Y-%m-%d") %m+% months(1) - 1)]

# Add geographic_identifier
CA[, `:=` (geographic_identifier = FISHING_GROUND_CODE)]
```

## Mapping

```{r Species_Gear_Fleet_Mapping, echo = TRUE}
# Merge with ASFIS species list
CA_MAPPEDSPECIES = merge(CA, MappingSpecies[src_codingsystem == "species_iotc" & trg_codingsystem == "species_asfis", .(src_code, species = trg_code)], by.x = "SPECIES_CODE", by.y = "src_code", all.x = TRUE)

# Merge with ISSCFG gear list
CA_MAPPEDSPECIESGEAR = merge(CA_MAPPEDSPECIES, MappingGear[src_codingsystem == "gear_iotc" & trg_codingsystem == "isscfg_revision_1", .(src_code, gear = trg_code)], by.x = "GEAR_CODE", by.y = "src_code", all.x = TRUE)

# Merge with FIRMS fleet list
CA_MAPPEDSPECIESGEARFLEET = merge(CA_MAPPEDSPECIESGEAR, MappingFleet[src_codingsystem == "fleet_iotc" & trg_codingsystem == "fleet_firms", .(src_code, fleet = trg_code)], by.x = "FLEET_CODE", by.y = "src_code", all.x=TRUE)
```

```{r Mapping_Check, echo = FALSE}
# Check if missing species
if (nrow(CA_MAPPEDSPECIES[is.na(species)])>0) print( paste("The following species codes are missing from the mapping: ", paste0(unique(CA_MAPPEDSPECIES[is.na(species), SPECIES_CODE]), collapse = "|")))

# Check if missing gears
if (nrow(CA_MAPPEDSPECIESGEAR[is.na(gear)])>0) print( paste("The following gear codes are missing from the mapping: ", paste0(unique(CA_MAPPEDSPECIESGEAR[is.na(gear), GEAR_CODE]), collapse = "|")))

# Check if missing fleets
if (nrow(CA_MAPPEDSPECIESGEARFLEET[is.na(fleet)])>0) print( paste("The following flag codes are missing from the mapping: ", paste0(unique(CA_MAPPEDSPECIESGEARFLEET[is.na(fleet), FLAG_CODE]), collapse = "|")))
```

## Exporting

```{r Dataset_Export, echo = TRUE}
# Build the full fisheries data set with mapping to GTA code lists
CA_FIRMS = CA_MAPPEDSPECIESGEARFLEET[, .(value = sum(CATCH, na.rm = TRUE)), by= .(fleet, gear, time_start, time_end, geographic_identifier, schooltype, species, catchtype, unit, source_authority)]

# Order columns
setcolorder(CA_FIRMS,neworder = c("fleet", "gear", "time_start", "time_end", "geographic_identifier", "schooltype", "species", "catchtype", "unit", "source_authority", "value"))

# Export the 1x1 monthly surface fisheries data set with mapping to GTA code lists
write.csv(CA_FIRMS, file = paste0("../outputs/datasets/iotc_catch_firms_level0_", Sys.Date(), ".csv"),row.names = FALSE)
```

\pagebreak

# RESULTS

The data processing resulted in the removal of `r round( sum(CA_RAW[CATCH_UNIT_CODE == "NO", CATCH]) - sum(CA_FIRMS[unit == "no", value]) )` fish and `r round( sum(CA_RAW[CATCH_UNIT_CODE == "MT", CATCH]) - sum(CA_FIRMS[unit == "t", value]) )` t of fish from the original data set through the filtering of species and spatio-temporal strata (**Table 1**). The mapping to the standard code lists reduced the number of gears from `r length(unique(CA_MAPPEDSPECIES$GEAR_CODE))` to `r length(unique(CA_MAPPEDSPECIESGEAR$gear))` and the fleets from `r length(unique(CA_MAPPEDSPECIES$FLEET_CODE))` to `r length(unique(CA_MAPPEDSPECIESGEARFLEET$fleet))` (**Table 1**). The species-specific geo-referenced catches included in the IOTC component of the FIRMS Global Tuna Atlas are included in **Table 5**.

**Table 1:** Description of the main components of the geo-referenced fisheries catch data sets throughout the processing steps for building the IOTC component of the FIRMS Global Tuna Atlas

| Data set  | Description | Species | Gears | Fleets | Catches (no) | Catches (t) | 
| :-------------------------------------  | :------------------------------------- | ----: | ----: | ----: | -------------: | --------------: |
| CA_RAW  | All species, gears, and fleets | `r length(unique(CA_RAW$SPECIES_CODE))` | `r length(unique(CA_RAW$GEAR_CODE))` | `r length(unique(CA_RAW$FLEET_CODE))` | `r round(sum(CA_RAW[CATCH_UNIT_CODE == "NO", CATCH]))` | `r round(sum(CA_RAW[CATCH_UNIT_CODE == "MT", CATCH]))` |
| CA_IO     | Keep species occurring in Indian Ocean | `r length(unique(CA_IO$SPECIES_CODE))` | `r length(unique(CA_IO$GEAR_CODE))` | `r length(unique(CA_IO$FLEET_CODE))` | `r round(sum(CA_IO[CATCH_UNIT_CODE == "NO", CATCH]))` | `r round(sum(CA_IO[CATCH_UNIT_CODE == "MT", CATCH]))` | 
| CA  | Selection of regular strata  | `r length(unique(CA$SPECIES_CODE))` | `r length(unique(CA$GEAR_CODE))` | `r length(unique(CA$FLEET_CODE))` | `r round(sum(CA[CATCH_UNIT_CODE == "NO", CATCH]))` | `r round(sum(CA[CATCH_UNIT_CODE == "MT", CATCH]))` |
| CA_MAPPEDSPECIES | Species mapped with ASFIS code list | `r length(unique(CA_MAPPEDSPECIES$species))` | `r length(unique(CA_MAPPEDSPECIES$GEAR_CODE))` | `r length(unique(CA_MAPPEDSPECIES$FLEET_CODE))` | `r round(sum(CA_MAPPEDSPECIES[CATCH_UNIT_CODE == "NO", CATCH]))` | `r round(sum(CA_MAPPEDSPECIES[CATCH_UNIT_CODE == "MT", CATCH]))` |
| CA_MAPPEDSPECIESGEAR | Gears mapped with ISSCFG code list | `r length(unique(CA_MAPPEDSPECIESGEAR$species))` | `r length(unique(CA_MAPPEDSPECIESGEAR$gear))` | `r length(unique(CA_MAPPEDSPECIESGEAR$FLEET_CODE))` | `r round(sum(CA_MAPPEDSPECIESGEAR[CATCH_UNIT_CODE == "NO", CATCH]))` | `r round(sum(CA_MAPPEDSPECIESGEAR[CATCH_UNIT_CODE == "MT", CATCH]))` |
| CA_MAPPEDSPECIESGEARFLEET | Fleets mapped with FIRMS fleet code list | `r length(unique(CA_MAPPEDSPECIESGEARFLEET$species))` | `r length(unique(CA_MAPPEDSPECIESGEARFLEET$gear))` | `r length(unique(CA_MAPPEDSPECIESGEARFLEET$fleet))` | `r round(sum(CA_MAPPEDSPECIESGEARFLEET[CATCH_UNIT_CODE == "NO", CATCH]))` | `r round(sum(CA_MAPPEDSPECIESGEARFLEET[CATCH_UNIT_CODE == "MT", CATCH]))` |

<br />

```{r Species_Excluded_Catch}
CA_SPECIES_EXCLUDED = CA_RAW[SPECIES_CODE=="MLW", SPECIES_CODE := "WHM"][SPECIES_CODE %in% SpeciesExcluded, .(YEAR_START = min(YEAR), YEAR_END = max(YEAR), CATCH = sum(CATCH)), keyby = .(SPECIES_CODE, CATCH_UNIT_CODE)]

# Add species information
CA_SPECIES_EXCLUDED_TABLE = merge(CA_SPECIES_EXCLUDED, Species[,.(code, label, scientific_name, family)], by.x = "SPECIES_CODE", by.y = "code", all.x = TRUE)[, .(CODE = SPECIES_CODE, FAMILY = family, NAME = label, SCIENTIFIC_NAME = paste0("_", scientific_name, "_"), YEAR_START, YEAR_END, UNIT = CATCH_UNIT_CODE, CATCH = prettyNum(round(CATCH), big.mark = ","))][order(FAMILY, CODE)]
```

A total of `r length(unique(SpeciesExcluded))-1` species were removed from the data set, representing `r sum(CA_RAW[SPECIES_CODE %in% SpeciesExcluded & CATCH_UNIT_CODE == "NO", CATCH])` fish and `r sum(CA_RAW[SPECIES_CODE %in% SpeciesExcluded & CATCH_UNIT_CODE == "MT", CATCH])` t of fish. The catches excluded are dominated by southern bluefin tuna (SBF) which represented `r round(sum(CA_RAW[SPECIES_CODE == "SBF" & CATCH_UNIT_CODE == "NO", CATCH])/sum(CA_RAW[SPECIES_CODE %in% SpeciesExcluded & CATCH_UNIT_CODE == "NO",CATCH])*100,2)`% and `r round(sum(CA_RAW[SPECIES_CODE == "SBF" & CATCH_UNIT_CODE == "MT", CATCH])/sum(CA_RAW[SPECIES_CODE %in% SpeciesExcluded & CATCH_UNIT_CODE == "MT",CATCH])*100,2)`% of the total catches excluded from the original data set in number and weight, respectively (**Table 2**). SBF catches are available from the CCSBT data sets available in the FIRMS Global Tuna Atlas. The other species removed only occur in the Atlantic Ocean.

```{r Display_Species_Excluded_Catch}
kable(CA_SPECIES_EXCLUDED_TABLE, row.names = FALSE, align = c("l", "l", "l" ,"l", "r", "r", "l", "r"), caption = "Total geo-referenced catches of tuna and tuna-like species included in the IOTC database for the period 1950-2019 and excluded from the data set exported to the FIRMS Tuna Atlas following the filter on species")
```

```{r Spatial_Strata_Excluded}
# Extract data not complying with 111 and 5x5 grids
CA_EXCLUDED_SPATIAL = merge(CA_IO[!as.numeric(substr(FISHING_GROUND_CODE,1,1)) %in% c(1,2,3,4,5,6)],  filter_grids()[, .(FISHING_GROUND_CODE, FISHING_GROUND_TYPE)], by = "FISHING_GROUND_CODE", all.x = TRUE)

# Irregular grids (not included in filter_grids())
CA_EXCLUDED_SPATIAL[is.na(FISHING_GROUND_TYPE), FISHING_GROUND_TYPE := "IRREGULAR"]

# Compute the catches excluded by type of grid
CA_EXCLUDED_SPATIAL_TABLE = CA_EXCLUDED_SPATIAL[, .(CATCH = prettyNum(round(sum(CATCH)),big.mark = ",")), keyby = .(GRID_TYPE = FISHING_GROUND_TYPE, UNIT = CATCH_UNIT_CODE)]
```

A total of `r length(unique(CA_EXCLUDED_SPATIAL$FISHING_GROUND_CODE))` spatial grids different from the 1x1° and 5x5° resolution were removed from the data set, representing `r round(sum(CA_EXCLUDED_SPATIAL[CATCH_UNIT_CODE == "MT", CATCH]))` t of fish. The catches excluded from the data set by type of spatial stratum are given in **Table 3**.

```{r Display_Spatial_Strata_Excluded}
kable(CA_EXCLUDED_SPATIAL_TABLE, row.names = FALSE, align = c("l", "l", "r"), caption = "Total geo-referenced catches of tuna and tuna-like species as included in the IOTC database for the period 1950-2019 and excluded from the data set exported to the FIRMS Tuna Atlas following the filter on spatial resolution")
```

```{r Species_Included_Catch}
# Compute catch by species
CA_FIRMS_SPECIES_INCLUDED = CA_FIRMS[, .(START = min(year(time_start)), END = max(year(time_end)), CATCH = sum(value)), keyby=.(species, unit)]

# Add species information
CA_FIRMS_SPECIES_INCLUDED_TABLE = merge(CA_FIRMS_SPECIES_INCLUDED[round(CATCH)>0], Species[, .(code, label, scientific_name, family)], by.x = "species", by.y = "code", all.x = TRUE)[, .(CODE = species, FAMILY = family, NAME = label, SCIENTIFIC_NAME = fifelse(scientific_name != "NA", paste0("_", scientific_name, "_"), ""), START, END, UNIT = unit, CATCH = prettyNum(round(CATCH), big.mark = ","))][order(FAMILY, CODE)]
```

```{r Display_Species_Included_Catch}
kable(CA_FIRMS_SPECIES_INCLUDED_TABLE, row.names = FALSE, align = c("l", "l", "l", "l", "r", "r", "l", "r"), caption = "Total geo-referenced catches (t) of tuna and tuna-like species as included in the data set exported to the FIRMS Global Tuna Atlas")
```

\pagebreak

# MAPPING TABLES

\beginsupplement

```{r MappingSpeciesTable}
kable(MappingSpecies[src_code != trg_code, .(IOTC = src_code, ASFIS = trg_code)][order(IOTC)], row.names = TRUE, caption = "Mapping of species or groups of species codes from the IOTC database to the ASFIS code list used for the FIRMS Global Tuna Atlas when the source and target codes differ")
```

\pagebreak

```{r MappingGearsTable}
kable(MappingGear[, .(IOTC = src_code, ISSCFG = trg_code)][order(IOTC)], row.names = TRUE, caption = "Mapping of gears or groups of gear codes from the IOTC database to the ISSCFG code list used for the FIRMS Global Tuna Atlas")
```

\pagebreak

```{r MappingFleetsTable}
kable(MappingFleet[src_code != trg_code, .(IOTC = src_code, FIRMS = trg_code)][order(IOTC)], row.names = TRUE, caption = "Mapping of fleet codes from the IOTC database to the code list used for the FIRMS Global Tuna Atlas when the source and target codes differ")
```


